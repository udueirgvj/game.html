<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¨Ù‚Ø§Ø¡ - ØºØ§Ø¨Ø© ÙˆØ§Ù‚Ø¹ÙŠØ©</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none;
        }
        #info {
            position: absolute;
            top: 15px;
            left: 15px;
            color: white;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 14px;
            backdrop-filter: blur(5px);
            z-index: 10;
            pointer-events: none;
            border: 1px solid rgba(255,255,255,0.3);
        }
        #cam-status {
            position: absolute;
            top: 15px;
            right: 15px;
            color: white;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 14px;
            backdrop-filter: blur(5px);
            z-index: 10;
            pointer-events: none;
            border: 1px solid rgba(255,255,255,0.3);
        }
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù„Ù…Ø³ */
        .touch-controls {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
            z-index: 20;
            pointer-events: none;
        }
        .wasd-panel {
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: auto;
        }
        .wasd-row {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        .ctrl-btn {
            width: 70px;
            height: 70px;
            border-radius: 35px;
            background: rgba(30, 30, 30, 0.7);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 215, 0, 0.6);
            color: gold;
            font-size: 28px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.1s;
            touch-action: manipulation;
            text-shadow: 0 2px 5px black;
        }
        .ctrl-btn:active, .ctrl-btn.active {
            background: rgba(255, 215, 0, 0.8);
            color: black;
            transform: scale(0.9);
            border-color: white;
        }
        .camera-btn {
            width: 80px;
            height: 80px;
            border-radius: 40px;
            background: rgba(50, 50, 150, 0.7);
            backdrop-filter: blur(10px);
            border: 2px solid #00ffff;
            color: cyan;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .camera-btn:active {
            background: rgba(0, 255, 255, 0.8);
            color: black;
        }
        @media (max-width: 600px) {
            .ctrl-btn { width: 60px; height: 60px; font-size: 24px; }
            .camera-btn { width: 70px; height: 70px; font-size: 16px; }
        }
    </style>
</head>
<body>
    <div id="info">ğŸŒ² Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¨Ù‚Ø§Ø¡ ÙÙŠ Ø§Ù„ØºØ§Ø¨Ø© | WASD Ù„Ù„Ø­Ø±ÙƒØ© | C Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</div>
    <div id="cam-status">ğŸ“· ÙƒØ§Ù…ÙŠØ±Ø§: Ø®Ù„ÙÙŠØ©</div>

    <div class="touch-controls">
        <div class="wasd-panel">
            <div class="wasd-row">
                <button class="ctrl-btn" id="btn-w">W</button>
            </div>
            <div class="wasd-row">
                <button class="ctrl-btn" id="btn-a">A</button>
                <button class="ctrl-btn" id="btn-s">S</button>
                <button class="ctrl-btn" id="btn-d">D</button>
            </div>
        </div>
        <button class="camera-btn" id="btn-c">C</button>
    </div>

    <!-- Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.128.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { Sky } from 'three/addons/objects/Sky.js';
        import { Water } from 'three/addons/objects/Water.js';

        // --- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø´Ù‡Ø¯ ÙˆØ§Ù„Ø±Ù†Ø¯Ø± ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB); // Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ø§Ù„Ø³Ù…Ø§Ø¡
        scene.fog = new THREE.FogExp2(0x89b6b5, 0.002); // Ø¶Ø¨Ø§Ø¨ Ø®ÙÙŠÙ

        const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.shadowMap.bias = 0.0001;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;
        document.body.appendChild(renderer.domElement);

        // --- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª ---
        const cameraFollow = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        cameraFollow.position.set(5, 3, 7);

        const cameraFree = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        cameraFree.position.set(15, 10, 20);

        let activeCamera = cameraFollow;
        const controls = new OrbitControls(cameraFree, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.maxPolarAngle = Math.PI / 2.2;
        controls.enableZoom = true;
        controls.enabled = false;

        // --- Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø© Ø§Ù„Ù…Ø­ÙŠØ·Ø© (Hemisphere) Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø¶ÙˆØ¡ Ø§Ù„Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø£Ø±Ø¶ ---
        const hemiLight = new THREE.HemisphereLight(0x88ccff, 0x335511, 1.2);
        scene.add(hemiLight);

        // --- Ø¥Ø¶Ø§Ø¡Ø© Ø´Ù…Ø³ÙŠØ© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© (Ù…Ø¹ Sky) ---
        const sunLight = new THREE.DirectionalLight(0xffeedd, 1.5);
        sunLight.castShadow = true;
        sunLight.shadow.mapSize.width = 2048;
        sunLight.shadow.mapSize.height = 2048;
        sunLight.shadow.camera.near = 1;
        sunLight.shadow.camera.far = 80;
        sunLight.shadow.camera.left = -30;
        sunLight.shadow.camera.right = 30;
        sunLight.shadow.camera.top = 30;
        sunLight.shadow.camera.bottom = -30;
        sunLight.shadow.bias = -0.0005;
        sunLight.shadow.normalBias = 0.02;
        scene.add(sunLight);

        // --- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ù…Ø§Ø¡ (Sky) ---
        const sky = new Sky();
        sky.scale.setScalar(450);
        scene.add(sky);

        const skyUniforms = sky.material.uniforms;
        skyUniforms['turbidity'].value = 10;   // ØªØ¹ÙƒØ±
        skyUniforms['rayleigh'].value = 2;     // ØªØ´ØªØª
        skyUniforms['mieCoefficient'].value = 0.005;
        skyUniforms['mieDirectionalG'].value = 0.8;
        
        // --- Ø£Ø±Ø¶ÙŠØ© ÙˆØ§Ù‚Ø¹ÙŠØ© Ù…Ø¹ Ù†Ø³ÙŠØ¬ Ø¹Ø´Ø¨ (Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø³ÙŠØ¬ Ù…Ù† three.js examples) ---
        const textureLoader = new THREE.TextureLoader();
        const grassColor = textureLoader.load('https://threejs.org/examples/textures/terrain/grass_01_diff_1k.jpg');
        const grassNormal = textureLoader.load('https://threejs.org/examples/textures/terrain/grass_01_nor_gl_1k.jpg');
        const grassRough = textureLoader.load('https://threejs.org/examples/textures/terrain/grass_01_rough_1k.jpg');
        
        grassColor.wrapS = THREE.RepeatWrapping;
        grassColor.wrapT = THREE.RepeatWrapping;
        grassColor.repeat.set(20, 20);
        grassNormal.wrapS = THREE.RepeatWrapping;
        grassNormal.wrapT = THREE.RepeatWrapping;
        grassNormal.repeat.set(20, 20);
        grassRough.wrapS = THREE.RepeatWrapping;
        grassRough.wrapT = THREE.RepeatWrapping;
        grassRough.repeat.set(20, 20);

        const groundMat = new THREE.MeshStandardMaterial({
            map: grassColor,
            normalMap: grassNormal,
            roughnessMap: grassRough,
            roughness: 0.7,
            metalness: 0.1
        });

        const groundGeo = new THREE.CircleGeometry(200, 64);
        const ground = new THREE.Mesh(groundGeo, groundMat);
        ground.rotation.x = -Math.PI / 2;
        ground.position.y = 0;
        ground.receiveShadow = true;
        scene.add(ground);

        // --- Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚Ø© Ø¹Ø´Ø¨ ØµØºÙŠØ±Ø© (ÙƒØ§Ø¦Ù†Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… InstancedMesh) ---
        const bladeGeo = new THREE.ConeGeometry(0.1, 0.4, 3);
        const bladeMat = new THREE.MeshStandardMaterial({ color: 0x4a7a4a });
        const bladeCount = 3000;
        const instancedGrass = new THREE.InstancedMesh(bladeGeo, bladeMat, bladeCount);
        instancedGrass.castShadow = true;
        instancedGrass.receiveShadow = true;

        const dummy = new THREE.Object3D();
        for (let i = 0; i < bladeCount; i++) {
            const radius = 30 + Math.random() * 70;
            const angle = Math.random() * Math.PI * 2;
            const x = Math.cos(angle) * radius;
            const z = Math.sin(angle) * radius;
            dummy.position.set(x, 0.2, z);
            dummy.rotation.y = Math.random() * Math.PI;
            dummy.scale.set(1, 0.8 + Math.random() * 0.7, 1);
            dummy.updateMatrix();
            instancedGrass.setMatrixAt(i, dummy.matrix);
        }
        instancedGrass.instanceMatrix.needsUpdate = true;
        scene.add(instancedGrass);

        // --- Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø®ØµÙŠØ© Ø±Ø¦ÙŠØ³ÙŠØ© Ù…ÙØµÙ„Ø© (Ø¨Ø£Ø³Ù„ÙˆØ¨ realistic blocky) ---
        function createCharacter() {
            const group = new THREE.Group();

            // Ù…ÙˆØ§Ø¯
            const skinMat = new THREE.MeshStandardMaterial({ color: 0xe0ac69, roughness: 0.4 });
            const pantsMat = new THREE.MeshStandardMaterial({ color: 0x3a5f8a, roughness: 0.6 });
            const shirtMat = new THREE.MeshStandardMaterial({ color: 0xaa5533, roughness: 0.5 });
            const eyeMat = new THREE.MeshStandardMaterial({ color: 0x000000 });
            const hairMat = new THREE.MeshStandardMaterial({ color: 0x4a2c1a });

            // Ø§Ù„Ø¬Ø³Ù…
            const bodyGeo = new THREE.CylinderGeometry(0.6, 0.6, 1.4);
            const body = new THREE.Mesh(bodyGeo, shirtMat);
            body.castShadow = true;
            body.receiveShadow = true;
            body.position.y = 0.9;
            group.add(body);

            // Ø§Ù„Ø±Ø£Ø³
            const headGeo = new THREE.SphereGeometry(0.5, 24);
            const head = new THREE.Mesh(headGeo, skinMat);
            head.castShadow = true;
            head.receiveShadow = true;
            head.position.y = 1.8;
            group.add(head);

            // Ø¹ÙŠÙˆÙ†
            const eyeGeo = new THREE.SphereGeometry(0.1, 8);
            const eyeL = new THREE.Mesh(eyeGeo, eyeMat);
            eyeL.position.set(-0.2, 1.95, 0.45);
            group.add(eyeL);
            const eyeR = new THREE.Mesh(eyeGeo, eyeMat);
            eyeR.position.set(0.2, 1.95, 0.45);
            group.add(eyeR);

            // Ù‚Ø¨Ø¹Ø© Ø£Ùˆ Ø´Ø¹Ø±
            const hairGeo = new THREE.ConeGeometry(0.45, 0.3, 8);
            const hair = new THREE.Mesh(hairGeo, hairMat);
            hair.position.set(0, 2.15, 0);
            hair.rotation.x = 0.1;
            group.add(hair);

            // Ø§Ù„Ø£Ø±Ø¬Ù„
            const legGeo = new THREE.CylinderGeometry(0.25, 0.25, 1.0);
            const legL = new THREE.Mesh(legGeo, pantsMat);
            legL.castShadow = true;
            legL.receiveShadow = true;
            legL.position.set(-0.25, 0.5, 0);
            group.add(legL);
            const legR = new THREE.Mesh(legGeo, pantsMat);
            legR.castShadow = true;
            legR.receiveShadow = true;
            legR.position.set(0.25, 0.5, 0);
            group.add(legR);

            // Ø§Ù„Ø°Ø±Ø§Ø¹Ø§Ù†
            const armGeo = new THREE.CylinderGeometry(0.2, 0.2, 1.1);
            const armL = new THREE.Mesh(armGeo, skinMat);
            armL.castShadow = true;
            armL.receiveShadow = true;
            armL.position.set(-0.65, 1.2, 0);
            armL.rotation.z = 0.2;
            group.add(armL);
            const armR = new THREE.Mesh(armGeo, skinMat);
            armR.castShadow = true;
            armR.receiveShadow = true;
            armR.position.set(0.65, 1.2, 0);
            armR.rotation.z = -0.2;
            group.add(armR);

            return group;
        }

        const player = createCharacter();
        player.position.set(0, 0.5, 0);
        player.castShadow = true;
        player.receiveShadow = true;
        scene.add(player);

        // --- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø´Ø¬Ø§Ø± Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠØ© ---
        function createRealisticTree(x, z) {
            const group = new THREE.Group();

            // Ù…ÙˆØ§Ø¯
            const barkMat = new THREE.MeshStandardMaterial({ color: 0x6b4c3b, roughness: 0.8 });
            const leafMat = new THREE.MeshStandardMaterial({ color: 0x2d6a4f, roughness: 0.4, emissive: 0x112211 });

            // Ø¬Ø°Ø¹ Ø±Ø¦ÙŠØ³ÙŠ (Ø£Ø³Ø·ÙˆØ§Ù†Ø©)
            const trunkGeo = new THREE.CylinderGeometry(0.8, 1.2, 5);
            const trunk = new THREE.Mesh(trunkGeo, barkMat);
            trunk.castShadow = true;
            trunk.receiveShadow = true;
            trunk.position.y = 2.5;
            group.add(trunk);

            // ÙØ±ÙˆØ¹ (Ø£Ø³Ø·ÙˆØ§Ù†Ø§Øª ØµØºÙŠØ±Ø© Ù…Ø§Ø¦Ù„Ø©)
            const branchGeo = new THREE.CylinderGeometry(0.3, 0.4, 2);
            
            const branch1 = new THREE.Mesh(branchGeo, barkMat);
            branch1.castShadow = true;
            branch1.receiveShadow = true;
            branch1.position.set(0.8, 3.5, 0.5);
            branch1.rotation.z = 0.4;
            branch1.rotation.x = 0.3;
            group.add(branch1);

            const branch2 = new THREE.Mesh(branchGeo, barkMat);
            branch2.castShadow = true;
            branch2.receiveShadow = true;
            branch2.position.set(-0.7, 4.0, -0.6);
            branch2.rotation.z = -0.3;
            branch2.rotation.x = -0.2;
            group.add(branch2);

            // Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø´Ø¬Ø± (ÙƒØ±Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©)
            const leafGeo = new THREE.SphereGeometry(1.0, 7);
            
            const leaf1 = new THREE.Mesh(leafGeo, leafMat);
            leaf1.castShadow = true;
            leaf1.receiveShadow = true;
            leaf1.position.set(0, 5.5, 0);
            leaf1.scale.set(1.5, 1.2, 1.5);
            group.add(leaf1);

            const leaf2 = new THREE.Mesh(leafGeo, leafMat);
            leaf2.castShadow = true;
            leaf2.receiveShadow = true;
            leaf2.position.set(0.8, 4.8, 0.8);
            leaf2.scale.set(1.2, 1.0, 1.2);
            group.add(leaf2);

            const leaf3 = new THREE.Mesh(leafGeo, leafMat);
            leaf3.castShadow = true;
            leaf3.receiveShadow = true;
            leaf3.position.set(-0.9, 4.5, -0.7);
            leaf3.scale.set(1.2, 1.0, 1.2);
            group.add(leaf3);

            const leaf4 = new THREE.Mesh(leafGeo, leafMat);
            leaf4.castShadow = true;
            leaf4.receiveShadow = true;
            leaf4.position.set(0.5, 6.0, -0.5);
            leaf4.scale.set(1.1, 0.9, 1.1);
            group.add(leaf4);

            group.position.set(x, 0, z);
            return group;
        }

        // Ø¥Ø¶Ø§ÙØ© ØºØ§Ø¨Ø© ÙƒØ«ÙŠÙØ©
        for (let i = 0; i < 40; i++) {
            const angle = Math.random() * Math.PI * 2;
            const radius = 10 + Math.random() * 40;
            const x = Math.cos(angle) * radius;
            const z = Math.sin(angle) * radius;
            const tree = createRealisticTree(x, z);
            scene.add(tree);
        }

        // --- Ø¥Ø¶Ø§ÙØ© Ø­ÙŠÙˆØ§Ù†Ø§Øª (ØºØ²Ø§Ù„ ÙˆØ£Ø±Ù†Ø¨) ---
        function createDeer(x, z) {
            const group = new THREE.Group();
            const brownMat = new THREE.MeshStandardMaterial({ color: 0x8B5A2B });
            const lightBrownMat = new THREE.MeshStandardMaterial({ color: 0xC19A6B });

            // Ø¬Ø³Ù…
            const bodyGeo = new THREE.CylinderGeometry(0.6, 0.6, 1.2);
            const body = new THREE.Mesh(bodyGeo, brownMat);
            body.castShadow = true;
            body.receiveShadow = true;
            body.position.y = 0.8;
            body.rotation.z = 0.1;
            group.add(body);

            // Ø±Ø£Ø³
            const headGeo = new THREE.SphereGeometry(0.4);
            const head = new THREE.Mesh(headGeo, lightBrownMat);
            head.castShadow = true;
            head.receiveShadow = true;
            head.position.set(0.6, 1.2, 0.3);
            group.add(head);

            // Ø£Ø±Ø¬Ù„
            const legGeo = new THREE.CylinderGeometry(0.2, 0.2, 0.8);
            for (let i = 0; i < 4; i++) {
                const leg = new THREE.Mesh(legGeo, brownMat);
                leg.castShadow = true;
                leg.receiveShadow = true;
                leg.position.set(i < 2 ? -0.4 : 0.4, 0.4, i % 2 === 0 ? 0.3 : -0.3);
                group.add(leg);
            }

            // Ù‚Ø±ÙˆÙ† (Ø¨Ø³ÙŠØ·Ø©)
            const hornGeo = new THREE.ConeGeometry(0.1, 0.6);
            const hornMat = new THREE.MeshStandardMaterial({ color: 0x5a3e2b });
            const hornL = new THREE.Mesh(hornGeo, hornMat);
            hornL.position.set(0.2, 1.6, 0.2);
            hornL.rotation.z = -0.3;
            group.add(hornL);
            const hornR = new THREE.Mesh(hornGeo, hornMat);
            hornR.position.set(0.2, 1.6, -0.1);
            hornR.rotation.z = -0.3;
            group.add(hornR);

            group.position.set(x, 0.2, z);
            return group;
        }

        function createRabbit(x, z) {
            const group = new THREE.Group();
            const whiteMat = new THREE.MeshStandardMaterial({ color: 0xf5f5f5 });
            const pinkMat = new THREE.MeshStandardMaterial({ color: 0xffaaaa });

            const body = new THREE.Mesh(new THREE.SphereGeometry(0.5), whiteMat);
            body.castShadow = true;
            body.receiveShadow = true;
            body.position.y = 0.4;
            group.add(body);

            const head = new THREE.Mesh(new THREE.SphereGeometry(0.3), whiteMat);
            head.castShadow = true;
            head.receiveShadow = true;
            head.position.set(0, 0.8, 0.4);
            group.add(head);

            const earGeo = new THREE.ConeGeometry(0.15, 0.6);
            const earL = new THREE.Mesh(earGeo, pinkMat);
            earL.position.set(-0.15, 1.1, 0.3);
            earL.rotation.z = -0.2;
            group.add(earL);
            const earR = new THREE.Mesh(earGeo, pinkMat);
            earR.position.set(0.15, 1.1, 0.3);
            earR.rotation.z = 0.2;
            group.add(earR);

            group.position.set(x, 0, z);
            return group;
        }

        const deer1 = createDeer(12, 8);
        const deer2 = createDeer(-8, 15);
        const rabbit1 = createRabbit(5, -6);
        const rabbit2 = createRabbit(-10, -12);
        scene.add(deer1);
        scene.add(deer2);
        scene.add(rabbit1);
        scene.add(rabbit2);

        // --- Ø¥Ø¶Ø§ÙØ© Ø¨Ø­ÙŠØ±Ø© ØµØºÙŠØ±Ø© (Ù…Ø§Ø¡) ---
        const waterGeometry = new THREE.CircleGeometry(15, 32);
        const water = new Water(waterGeometry, {
            textureWidth: 512,
            textureHeight: 512,
            waterNormals: textureLoader.load('https://threejs.org/examples/textures/water/Water_1_M_Normal.jpg'),
            sunDirection: new THREE.Vector3(1, 1, 1),
            sunColor: 0xffaa88,
            waterColor: 0x336699,
            distortionScale: 3.7,
            fog: true
        });
        water.rotation.x = -Math.PI / 2;
        water.position.set(20, 0.1, 20);
        water.receiveShadow = true;
        scene.add(water);

        // --- ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø´Ù…Ø³ ÙˆØ§Ù„Ø³Ù…Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª (ØªØ£Ø«ÙŠØ± Ù†Ù‡Ø§Ø±ÙŠ) ---
        let sunAngle = 0;

        function updateSun() {
            sunAngle += 0.001;
            const sunPos = new THREE.Vector3(
                Math.cos(sunAngle) * 80,
                Math.sin(sunAngle) * 80 + 20,
                50
            );
            sunLight.position.copy(sunPos);
            skyUniforms['sunPosition'].value.copy(sunPos);
        }

        // --- Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø´Ø®ØµÙŠØ© (WASD) Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ÙˆØ§Ù„Ù„Ù…Ø³ ---
        const keyState = { w: false, a: false, s: false, d: false };

        // Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
        window.addEventListener('keydown', (e) => {
            if (e.code === 'KeyW' || e.code === 'KeyA' || e.code === 'KeyS' || e.code === 'KeyD' || e.code === 'KeyC') {
                e.preventDefault();
            }
            switch(e.code) {
                case 'KeyW': keyState.w = true; break;
                case 'KeyA': keyState.a = true; break;
                case 'KeyS': keyState.s = true; break;
                case 'KeyD': keyState.d = true; break;
                case 'KeyC':
                    activeCamera = (activeCamera === cameraFollow) ? cameraFree : cameraFollow;
                    controls.enabled = (activeCamera === cameraFree);
                    document.getElementById('cam-status').innerText = 
                        activeCamera === cameraFollow ? 'ğŸ“· ÙƒØ§Ù…ÙŠØ±Ø§: Ø®Ù„ÙÙŠØ©' : 'ğŸ“· ÙƒØ§Ù…ÙŠØ±Ø§: Ø­Ø±Ø©';
                    break;
            }
        });

        window.addEventListener('keyup', (e) => {
            if (e.code === 'KeyW' || e.code === 'KeyA' || e.code === 'KeyS' || e.code === 'KeyD') e.preventDefault();
            switch(e.code) {
                case 'KeyW': keyState.w = false; break;
                case 'KeyA': keyState.a = false; break;
                case 'KeyS': keyState.s = false; break;
                case 'KeyD': keyState.d = false; break;
            }
        });

        // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù„Ù…Ø³
        const btnW = document.getElementById('btn-w');
        const btnA = document.getElementById('btn-a');
        const btnS = document.getElementById('btn-s');
        const btnD = document.getElementById('btn-d');
        const btnC = document.getElementById('btn-c');

        function setActive(btn, state) {
            if (state) btn.classList.add('active');
            else btn.classList.remove('active');
        }

        btnW.addEventListener('touchstart', (e) => { e.preventDefault(); keyState.w = true; setActive(btnW, true); });
        btnW.addEventListener('touchend', (e) => { e.preventDefault(); keyState.w = false; setActive(btnW, false); });
        btnW.addEventListener('touchcancel', (e) => { e.preventDefault(); keyState.w = false; setActive(btnW, false); });

        btnA.addEventListener('touchstart', (e) => { e.preventDefault(); keyState.a = true; setActive(btnA, true); });
        btnA.addEventListener('touchend', (e) => { e.preventDefault(); keyState.a = false; setActive(btnA, false); });
        btnA.addEventListener('touchcancel', (e) => { e.preventDefault(); keyState.a = false; setActive(btnA, false); });

        btnS.addEventListener('touchstart', (e) => { e.preventDefault(); keyState.s = true; setActive(btnS, true); });
        btnS.addEventListener('touchend', (e) => { e.preventDefault(); keyState.s = false; setActive(btnS, false); });
        btnS.addEventListener('touchcancel', (e) => { e.preventDefault(); keyState.s = false; setActive(btnS, false); });

        btnD.addEventListener('touchstart', (e) => { e.preventDefault(); keyState.d = true; setActive(btnD, true); });
        btnD.addEventListener('touchend', (e) => { e.preventDefault(); keyState.d = false; setActive(btnD, false); });
        btnD.addEventListener('touchcancel', (e) => { e.preventDefault(); keyState.d = false; setActive(btnD, false); });

        btnC.addEventListener('touchstart', (e) => {
            e.preventDefault();
            activeCamera = (activeCamera === cameraFollow) ? cameraFree : cameraFollow;
            controls.enabled = (activeCamera === cameraFree);
            document.getElementById('cam-status').innerText = 
                activeCamera === cameraFollow ? 'ğŸ“· ÙƒØ§Ù…ÙŠØ±Ø§: Ø®Ù„ÙÙŠØ©' : 'ğŸ“· ÙƒØ§Ù…ÙŠØ±Ø§: Ø­Ø±Ø©';
        });

        // Ù†Ø³Ø® Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙØ£Ø±Ø© (Ù„Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±)
        btnW.addEventListener('mousedown', (e) => { e.preventDefault(); keyState.w = true; setActive(btnW, true); });
        btnW.addEventListener('mouseup', (e) => { e.preventDefault(); keyState.w = false; setActive(btnW, false); });
        btnW.addEventListener('mouseleave', (e) => { keyState.w = false; setActive(btnW, false); });
        btnA.addEventListener('mousedown', (e) => { e.preventDefault(); keyState.a = true; setActive(btnA, true); });
        btnA.addEventListener('mouseup', (e) => { e.preventDefault(); keyState.a = false; setActive(btnA, false); });
        btnA.addEventListener('mouseleave', (e) => { keyState.a = false; setActive(btnA, false); });
        btnS.addEventListener('mousedown', (e) => { e.preventDefault(); keyState.s = true; setActive(btnS, true); });
        btnS.addEventListener('mouseup', (e) => { e.preventDefault(); keyState.s = false; setActive(btnS, false); });
        btnS.addEventListener('mouseleave', (e) => { keyState.s = false; setActive(btnS, false); });
        btnD.addEventListener('mousedown', (e) => { e.preventDefault(); keyState.d = true; setActive(btnD, true); });
        btnD.addEventListener('mouseup', (e) => { e.preventDefault(); keyState.d = false; setActive(btnD, false); });
        btnD.addEventListener('mouseleave', (e) => { keyState.d = false; setActive(btnD, false); });
        btnC.addEventListener('click', (e) => {
            e.preventDefault();
            activeCamera = (activeCamera === cameraFollow) ? cameraFree : cameraFollow;
            controls.enabled = (activeCamera === cameraFree);
            document.getElementById('cam-status').innerText = 
                activeCamera === cameraFollow ? 'ğŸ“· ÙƒØ§Ù…ÙŠØ±Ø§: Ø®Ù„ÙÙŠØ©' : 'ğŸ“· ÙƒØ§Ù…ÙŠØ±Ø§: Ø­Ø±Ø©';
        });

        // --- Ø­Ù„Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---
        const clock = new THREE.Clock();

        function animate() {
            const delta = clock.getDelta();
            const elapsedTime = performance.now() / 1000;

            // Ø­Ø±ÙƒØ© Ø§Ù„Ø´Ø®ØµÙŠØ©
            const speed = 0.2;
            if (keyState.w) player.position.z -= speed;
            if (keyState.s) player.position.z += speed;
            if (keyState.a) player.position.x -= speed;
            if (keyState.d) player.position.x += speed;

            // ØªØ­Ø¯ÙŠØ« ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„ØªØªØ¨Ø¹
            if (activeCamera === cameraFollow) {
                const offset = new THREE.Vector3(-4, 3, 5);
                cameraFollow.position.copy(player.position.clone().add(offset));
                cameraFollow.lookAt(player.position);
            } else {
                controls.update();
            }

            // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª (Ø­Ø±ÙƒØ© Ø¨Ø³ÙŠØ·Ø©)
            deer1.position.y = 0.2 + Math.sin(elapsedTime * 3) * 0.05;
            deer2.position.y = 0.2 + Math.cos(elapsedTime * 4) * 0.05;
            rabbit1.position.y = Math.sin(elapsedTime * 5) * 0.1;
            rabbit2.position.y = Math.cos(elapsedTime * 6) * 0.1;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ù…Ø³
            updateSun();

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø§Ø¡
            water.material.uniforms['time'].value += delta;

            renderer.render(scene, activeCamera);
            requestAnimationFrame(animate);
        }

        animate();

        // --- ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø© ---
        window.addEventListener('resize', () => {
            cameraFollow.aspect = window.innerWidth / window.innerHeight;
            cameraFollow.updateProjectionMatrix();
            cameraFree.aspect = window.innerWidth / window.innerHeight;
            cameraFree.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        console.log('ğŸŒ² Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¨Ù‚Ø§Ø¡ Ø¬Ø§Ù‡Ø²Ø©!');
    </script>
</body>
</html>
