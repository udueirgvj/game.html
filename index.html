<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>لعبة ثلاثية الأبعاد - شخصية مفصلة</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 100;
            user-select: none;
            pointer-events: none;
        }
        #error-message {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: red;
            background: black;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <div id="info">استخدم WASD للتحرك | اضغط C لتبديل الكاميرا</div>
    <div id="error-message"></div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.126.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.126.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        // التقاط الأخطاء
        window.addEventListener('error', (e) => {
            const errorDiv = document.getElementById('error-message');
            errorDiv.style.display = 'block';
            errorDiv.textContent = 'خطأ: ' + e.message;
            console.error(e);
        });

        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- إعداد المشهد ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        // --- إضاءة ---
        const ambientLight = new THREE.AmbientLight(0x404060);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(10, 20, 5);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 1024;
        dirLight.shadow.mapSize.height = 1024;
        dirLight.shadow.camera.near = 0.5;
        dirLight.shadow.camera.far = 30;
        dirLight.shadow.camera.left = -15;
        dirLight.shadow.camera.right = 15;
        dirLight.shadow.camera.top = 15;
        dirLight.shadow.camera.bottom = -15;
        scene.add(dirLight);

        // --- أرضية بشبكة ---
        const gridHelper = new THREE.GridHelper(30, 20, 0xaaaaaa, 0x444444);
        scene.add(gridHelper);

        const groundGeo = new THREE.PlaneGeometry(30, 30);
        const groundMat = new THREE.MeshStandardMaterial({ color: 0x3a9e3a, side: THREE.DoubleSide });
        const ground = new THREE.Mesh(groundGeo, groundMat);
        ground.rotation.x = Math.PI / 2;
        ground.position.y = 0;
        ground.receiveShadow = true;
        scene.add(ground);

        // --- إنشاء شخصية مفصلة ---
        function createCharacter() {
            const group = new THREE.Group();

            // الأرجل (أسطوانات)
            const legMat = new THREE.MeshStandardMaterial({ color: 0x3366cc });
            const legGeo = new THREE.CylinderGeometry(0.3, 0.3, 1);
            
            const legLeft = new THREE.Mesh(legGeo, legMat);
            legLeft.castShadow = true;
            legLeft.receiveShadow = true;
            legLeft.position.set(-0.3, 0.5, 0);
            group.add(legLeft);
            
            const legRight = new THREE.Mesh(legGeo, legMat);
            legRight.castShadow = true;
            legRight.receiveShadow = true;
            legRight.position.set(0.3, 0.5, 0);
            group.add(legRight);

            // الجسم (صندوق)
            const bodyMat = new THREE.MeshStandardMaterial({ color: 0x44aa88 });
            const bodyGeo = new THREE.BoxGeometry(0.8, 1.2, 0.5);
            const body = new THREE.Mesh(bodyGeo, bodyMat);
            body.castShadow = true;
            body.receiveShadow = true;
            body.position.set(0, 1.3, 0);
            group.add(body);

            // الذراعان
            const armMat = new THREE.MeshStandardMaterial({ color: 0x3366cc });
            const armGeo = new THREE.CylinderGeometry(0.2, 0.2, 0.9);
            
            const armLeft = new THREE.Mesh(armGeo, armMat);
            armLeft.castShadow = true;
            armLeft.receiveShadow = true;
            armLeft.position.set(-0.6, 1.3, 0);
            armLeft.rotation.z = 0.2;
            group.add(armLeft);
            
            const armRight = new THREE.Mesh(armGeo, armMat);
            armRight.castShadow = true;
            armRight.receiveShadow = true;
            armRight.position.set(0.6, 1.3, 0);
            armRight.rotation.z = -0.2;
            group.add(armRight);

            // الرأس (كرة)
            const headMat = new THREE.MeshStandardMaterial({ color: 0xffccaa });
            const headGeo = new THREE.SphereGeometry(0.4, 16);
            const head = new THREE.Mesh(headGeo, headMat);
            head.castShadow = true;
            head.receiveShadow = true;
            head.position.set(0, 2.0, 0);
            group.add(head);

            // عينان صغيرتان
            const eyeMat = new THREE.MeshStandardMaterial({ color: 0x000000 });
            const eyeGeo = new THREE.SphereGeometry(0.1);
            const eyeL = new THREE.Mesh(eyeGeo, eyeMat);
            eyeL.position.set(-0.15, 2.1, 0.35);
            group.add(eyeL);
            const eyeR = new THREE.Mesh(eyeGeo, eyeMat);
            eyeR.position.set(0.15, 2.1, 0.35);
            group.add(eyeR);

            return group;
        }

        const player = createCharacter();
        player.position.set(0, 0, 0);
        player.castShadow = true;
        player.receiveShadow = true;
        scene.add(player);

        // --- إضافة عناصر بسيطة (أشجار وأرانب) لتزيين المشهد ---
        function createTree(x, z) {
            const group = new THREE.Group();
            // جذع
            const trunk = new THREE.Mesh(
                new THREE.CylinderGeometry(0.4, 0.6, 2),
                new THREE.MeshStandardMaterial({ color: 0x8B4513 })
            );
            trunk.castShadow = true;
            trunk.receiveShadow = true;
            trunk.position.y = 1;
            group.add(trunk);
            
            // أوراق (كرات خضراء)
            const leafMat = new THREE.MeshStandardMaterial({ color: 0x228822 });
            const leaf1 = new THREE.Mesh(new THREE.SphereGeometry(0.8), leafMat);
            leaf1.castShadow = true;
            leaf1.receiveShadow = true;
            leaf1.position.set(0, 2.2, 0);
            group.add(leaf1);
            
            group.position.set(x, 0, z);
            return group;
        }

        scene.add(createTree(5, 5));
        scene.add(createTree(-5, 4));
        scene.add(createTree(6, -3));
        scene.add(createTree(-4, -5));

        function createRabbit(x, z) {
            const group = new THREE.Group();
            const white = new THREE.MeshStandardMaterial({ color: 0xffffff });
            
            const body = new THREE.Mesh(new THREE.SphereGeometry(0.5), white);
            body.castShadow = true;
            body.receiveShadow = true;
            body.position.y = 0.5;
            group.add(body);
            
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.3), white);
            head.castShadow = true;
            head.receiveShadow = true;
            head.position.set(0, 0.9, 0.4);
            group.add(head);
            
            const earMat = new THREE.MeshStandardMaterial({ color: 0xdddddd });
            const earGeo = new THREE.ConeGeometry(0.15, 0.5);
            const earL = new THREE.Mesh(earGeo, earMat);
            earL.castShadow = true;
            earL.receiveShadow = true;
            earL.position.set(-0.2, 1.2, 0.3);
            group.add(earL);
            const earR = new THREE.Mesh(earGeo, earMat);
            earR.castShadow = true;
            earR.receiveShadow = true;
            earR.position.set(0.2, 1.2, 0.3);
            group.add(earR);
            
            group.position.set(x, 0, z);
            return group;
        }

        const rabbit1 = createRabbit(3, -2);
        const rabbit2 = createRabbit(-3, 3);
        scene.add(rabbit1);
        scene.add(rabbit2);

        // --- الكاميرات ---
        const cameraFollow = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        cameraFollow.position.set(5, 3, 5);

        const cameraFree = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        cameraFree.position.set(10, 10, 10);

        let activeCamera = cameraFollow;
        const controls = new OrbitControls(cameraFree, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.enabled = false;

        // --- التحكم بالمفاتيح ---
        const keyState = { w: false, a: false, s: false, d: false };

        window.addEventListener('keydown', (e) => {
            if (e.code === 'KeyW' || e.code === 'KeyA' || e.code === 'KeyS' || e.code === 'KeyD' || e.code === 'KeyC') {
                e.preventDefault();
            }
            
            console.log('ضغطت: ' + e.code);
            
            switch(e.code) {
                case 'KeyW': keyState.w = true; break;
                case 'KeyA': keyState.a = true; break;
                case 'KeyS': keyState.s = true; break;
                case 'KeyD': keyState.d = true; break;
                case 'KeyC':
                    activeCamera = (activeCamera === cameraFollow) ? cameraFree : cameraFollow;
                    controls.enabled = (activeCamera === cameraFree);
                    console.log('الكاميرا الآن: ' + (activeCamera === cameraFollow ? 'تتبع' : 'حرة'));
                    break;
            }
        });

        window.addEventListener('keyup', (e) => {
            if (e.code === 'KeyW' || e.code === 'KeyA' || e.code === 'KeyS' || e.code === 'KeyD') {
                e.preventDefault();
            }
            switch(e.code) {
                case 'KeyW': keyState.w = false; break;
                case 'KeyA': keyState.a = false; break;
                case 'KeyS': keyState.s = false; break;
                case 'KeyD': keyState.d = false; break;
            }
        });

        // --- حلقة اللعبة ---
        function animate() {
            // حركة الشخصية
            const speed = 0.1;
            if (keyState.w) player.position.z -= speed;
            if (keyState.s) player.position.z += speed;
            if (keyState.a) player.position.x -= speed;
            if (keyState.d) player.position.x += speed;

            // تحديث كاميرا التتبع
            if (activeCamera === cameraFollow) {
                const offset = new THREE.Vector3(-3, 2, 3);
                cameraFollow.position.copy(player.position.clone().add(offset));
                cameraFollow.lookAt(player.position);
            } else {
                controls.update();
            }

            // حركة الأرانب (بسيطة)
            const time = Date.now() * 0.001;
            rabbit1.position.y = Math.sin(time * 2) * 0.2;
            rabbit2.position.y = Math.cos(time * 2.5) * 0.2;

            renderer.render(scene, activeCamera);
            requestAnimationFrame(animate);
        }

        animate();

        // --- تغيير حجم النافذة ---
        window.addEventListener('resize', () => {
            cameraFollow.aspect = window.innerWidth / window.innerHeight;
            cameraFollow.updateProjectionMatrix();
            cameraFree.aspect = window.innerWidth / window.innerHeight;
            cameraFree.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        console.log('✅ اللعبة تعمل!');
    </script>
</body>
</html>
